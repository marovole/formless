# Formless 测试计划与用例

## 测试概览

| 模块 | 测试类型 | 优先级 |
|------|----------|--------|
| Landing Page | 功能 + UI | P0 |
| 用户认证 | 功能 + 安全 | P0 |
| 对话系统 | 功能 + 性能 | P0 |
| 记忆系统 | 功能 | P1 |
| 观照系统 | 功能 | P1 |
| Admin 后台 | 功能 + 权限 | P1 |
| SEO | 技术验证 | P2 |
| 移动端适配 | UI/UX | P2 |

---

## 测试环境

| 环境 | URL | 用途 |
|------|-----|------|
| Production | https://formless.pages.dev | 生产环境 |
| Preview | https://96ec52e0.formless.pages.dev | 当前预览 |
| Local | http://localhost:3000 | 本地开发 |

---

## P0 - 核心功能测试

### TC-001: Landing Page 加载

**前置条件**: 无需登录

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 访问首页 `/` | 页面加载完成，无白屏 |
| 2 | 检查 Header | 显示 Logo + 导航链接 + 语言切换器 |
| 3 | 检查 Hero 区域 | 显示标题「无相」+ 副标题 + 两个 CTA 按钮 |
| 4 | 检查 Features 区域 | 显示 6 个功能卡片，带图标 |
| 5 | 检查 Footer | 显示版权信息 + 法律链接 |
| 6 | 滚动页面 | Header 变为半透明毛玻璃效果 |

**验收标准**: 所有元素正确显示，无控制台错误

---

### TC-002: 语言切换

**前置条件**: 在 Landing Page

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击语言切换器 | 显示 8 种语言选项 |
| 2 | 选择「中文」 | URL 变为 `/zh`，页面内容切换为中文 |
| 3 | 选择「English」 | URL 变为 `/en`，页面内容切换为英文 |
| 4 | 选择「日本語」 | URL 变为 `/ja`，页面内容切换为日文 |

**验收标准**: 语言切换即时生效，无刷新

---

### TC-003: 用户注册

**前置条件**: 未登录状态

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击「Sign In」 | 跳转到 Clerk 登录页面 |
| 2 | 点击「Sign Up」 | 显示注册表单 |
| 3 | 输入有效邮箱和密码 | 发送验证邮件 |
| 4 | 完成邮箱验证 | 自动跳转到 `/chat` |
| 5 | 检查 Convex 用户表 | 用户记录已创建 |

**验收标准**: 用户成功创建并登录

---

### TC-004: 用户登录

**前置条件**: 已有账户

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 访问 `/sign-in` | 显示登录表单 |
| 2 | 输入正确邮箱和密码 | 登录成功 |
| 3 | 检查跳转 | 自动跳转到 `/chat` |
| 4 | 刷新页面 | 保持登录状态 |

**验收标准**: 登录后 session 持久化

---

### TC-005: 对话功能

**前置条件**: 已登录

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 访问 `/chat` | 显示空对话界面 |
| 2 | 输入消息「你好」 | 消息显示在右侧（用户气泡） |
| 3 | 等待响应 | AI 响应流式显示在左侧 |
| 4 | 检查响应内容 | 符合「无相长老」人设风格 |
| 5 | 发送第二条消息 | 对话继续，上下文保持 |

**验收标准**: 对话流畅，响应符合人设

---

### TC-006: 对话历史

**前置条件**: 已有至少一次对话

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 访问 `/history` | 显示对话列表 |
| 2 | 检查对话卡片 | 显示日期 + 预览文本 |
| 3 | 点击「Continue」 | 跳转到对应对话，显示历史消息 |
| 4 | 点击「Delete」 | 确认后删除对话 |
| 5 | 刷新页面 | 对话已从列表移除 |

**验收标准**: 历史记录正确显示和操作

---

## P1 - 核心功能测试

### TC-007: 记忆系统

**前置条件**: 已有多次对话

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在对话中提及个人信息（如「我叫张三」） | 消息发送成功 |
| 2 | 开始新对话 | 新对话界面 |
| 3 | 提问「你还记得我吗」 | AI 响应中包含之前提到的信息 |

**验收标准**: 跨对话记忆召回成功

---

### TC-008: Admin 访问控制

**前置条件**: 非 Admin 用户登录

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 访问 `/admin` | 重定向到首页 `/` |
| 2 | 使用 Admin 邮箱登录 | 登录成功 |
| 3 | 再次访问 `/admin` | 显示 Admin Dashboard |

**验收标准**: 权限隔离正确

---

### TC-009: API Key 管理

**前置条件**: Admin 用户登录

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 访问 `/admin/api-keys` | 显示 API Key 列表 |
| 2 | 点击「Add API Key」 | 显示创建表单 |
| 3 | 填写 provider=chutes, key=xxx | 创建成功 |
| 4 | 检查列表 | 新 key 显示，key 部分隐藏 (xxxx...yyyy) |
| 5 | 点击「Delete」 | 确认后删除 |

**验收标准**: CRUD 操作正常

---

### TC-010: Prompt 管理

**前置条件**: Admin 用户登录

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 访问 `/admin/prompts` | 显示 Prompt 列表 |
| 2 | 创建新 Prompt | role=system, language=zh |
| 3 | 编辑 content | 版本号自动递增 |
| 4 | 切换 is_active | 状态更新 |

**验收标准**: Prompt 版本控制正常

---

## P2 - 技术验证测试

### TC-011: SEO 验证

**前置条件**: 无

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 访问 `/robots.txt` | 显示 robots 配置 |
| 2 | 访问 `/sitemap.xml` | 显示 sitemap，包含 32 个 URL |
| 3 | 查看页面源码 | 包含 JSON-LD structured data |
| 4 | 检查 `<head>` | 包含 OpenGraph 和 Twitter meta tags |

**验收标准**: SEO 配置完整

---

### TC-012: 移动端适配

**前置条件**: 使用移动设备或模拟器

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 访问 Landing Page | 布局正确，无横向滚动 |
| 2 | 测试 Chat 页面 | 输入框可见，不被浏览器工具栏遮挡 |
| 3 | 测试 History 页面 | 卡片和按钮正确堆叠 |
| 4 | 测试 Settings 页面 | 内容不溢出屏幕 |

**验收标准**: 所有页面移动端友好

---

## 性能测试

### TC-013: 页面加载性能

| 指标 | 目标值 | 测试方法 |
|------|--------|----------|
| FCP (First Contentful Paint) | < 1.5s | Lighthouse |
| LCP (Largest Contentful Paint) | < 2.5s | Lighthouse |
| CLS (Cumulative Layout Shift) | < 0.1 | Lighthouse |
| TTI (Time to Interactive) | < 3.5s | Lighthouse |

---

### TC-014: 对话响应延迟

| 场景 | 目标值 | 测试方法 |
|------|--------|----------|
| 首次 Token 返回 | < 2s | 手动计时 |
| 完整响应 (100 字) | < 10s | 手动计时 |
| 流式渲染流畅度 | 无卡顿 | 目视检查 |

---

## 安全测试

### TC-015: 认证安全

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 未登录访问 `/chat` | 重定向到登录页 |
| 2 | 未登录访问 `/history` | 重定向到登录页 |
| 3 | 未登录访问 `/admin` | 重定向到登录页 |
| 4 | 伪造 JWT Token | 请求被拒绝 |

---

### TC-016: 数据隔离

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 用户 A 创建对话 | 对话保存 |
| 2 | 切换到用户 B | 看不到用户 A 的对话 |
| 3 | 用户 B 尝试访问用户 A 的对话 ID | 返回 403 |

---

## 测试数据

### 测试账户

| 角色 | 邮箱 | 用途 |
|------|------|------|
| 普通用户 | test@example.com | 用户功能测试 |
| Admin 用户 | (配置在 ADMIN_EMAILS) | Admin 功能测试 |

### 测试 Prompt

```
Role: system
Language: zh
Content: 你是无相长老，一位修行千年的智者...
```

---

## Bug 报告模板

```markdown
## Bug 标题

**环境**: Production / Preview / Local
**设备**: Desktop Chrome / Mobile Safari / ...
**账户类型**: Guest / User / Admin

### 复现步骤
1. ...
2. ...

### 预期结果
...

### 实际结果
...

### 截图/日志
...
```

---

## 测试进度跟踪

| 用例 ID | 测试人 | 测试日期 | 结果 | 备注 |
|---------|--------|----------|------|------|
| TC-001 | | | | |
| TC-002 | | | | |
| ... | | | | |

---

## 上线前一周检查清单（执行表）

| 序号 | 模块 | 检查项 | 优先级 | 验收标准 | 执行方式/命令 | 证据输出 | 负责人 | 状态 |
|---|---|---|---|---|---|---|---|---|
| 1 | 环境配置 | Cloudflare Pages 环境变量齐全 | P0 | `NEXT_PUBLIC_CONVEX_URL`/`CONVEX_ADMIN_TOKEN`/Clerk keys/`ADMIN_EMAILS` 已配置 | Cloudflare 控制台检查 | 截图或配置导出 |  | ☐ |
| 2 | 环境配置 | Convex 生产环境变量 | P0 | `CLERK_JWT_ISSUER_DOMAIN`、`ADMIN_EMAILS` 已设置 | Convex 控制台检查 | 截图 |  | ☐ |
| 3 | 认证 | Clerk JWT template | P0 | `convex` 模板 + `aud=convex` + `email` claim | Clerk 控制台检查 | 截图 |  | ☐ |
| 4 | 后端部署 | Convex 生产部署 | P0 | 部署成功、无错误 | `npx convex deploy --prod` | 终端输出 |  | ☐ |
| 5 | 前端构建 | Cloudflare Pages 构建 | P0 | 构建成功，无错误 | `npm run pages:build` | 终端输出 |  | ☐ |
| 6 | 前端部署 | Cloudflare Pages 发布 | P0 | 发布成功 | `npm run deploy` | 终端输出 |  | ☐ |
| 7 | Admin 初始化 | Admin 首次配置 | P0 | `/admin` 中创建 API Keys + Prompts 成功 | 手动操作 | 截图/记录 |  | ☐ |
| 8 | P0 测试 | Landing 加载 | P0 | 无白屏/无 console error | `docs/TEST_PLAN.md` TC-001 | 测试记录 |  | ☐ |
| 9 | P0 测试 | 语言切换 | P0 | 8 语言切换即时生效 | TC-002 | 测试记录 |  | ☐ |
| 10 | P0 测试 | 注册/登录 | P0 | 注册成功、登录持久 | TC-003/004 | 测试记录 |  | ☐ |
| 11 | P0 测试 | 对话流式 | P0 | 流式响应正常、风格正确 | TC-005 | 测试记录 |  | ☐ |
| 12 | P0 测试 | 历史记录 | P0 | 列表/继续/删除正常 | TC-006 | 测试记录 |  | ☐ |
| 13 | P1 测试 | 记忆召回 | P1 | 跨对话召回成功 | TC-007 | 测试记录 |  | ☐ |
| 14 | P1 测试 | Admin 访问控制 | P1 | 非管理员不可进 | TC-008 | 测试记录 |  | ☐ |
| 15 | P1 测试 | API Key 管理 | P1 | CRUD 正常 | TC-009 | 测试记录 |  | ☐ |
| 16 | P1 测试 | Prompt 管理 | P1 | 版本递增、激活可控 | TC-010 | 测试记录 |  | ☐ |
| 17 | P1 测试 | 观照功能 | P1 | 触发器生效、设置可用 | `docs/guanzhao/IMPLEMENTATION_CHECKLIST.md` | 测试记录 |  | ☐ |
| 18 | P2 测试 | SEO 校验 | P2 | robots/sitemap/meta 完整 | TC-011 | 测试记录 |  | ☐ |
| 19 | P2 测试 | 移动端适配 | P2 | 无溢出、关键页面可用 | TC-012 | 测试记录 |  | ☐ |
| 20 | 自动化 | 单测 | P0 | 全部通过 | `npm run test:run` | 2026-01-16 vitest 59/59 |  | ✅ |
| 21 | 自动化 | E2E | P0 | 全部通过 | `npm run test:e2e` | 失败：登录页未出现 identifier/email 输入 |  | ☐ |
| 22 | 自动化 | 全量测试 | P0 | 全部通过 | `npm run test:all` | 失败：E2E 超时（单测通过） |  | ☐ |
| 23 | 文档一致性 | PRD/Dev Plan 更新 | P1 | 状态与现状一致 | 手动更新 | PR/记录 |  | ☐ |
| 24 | 监控准备 | 监控/告警确认 | P1 | 可查看日志与错误 | 平台检查 | 截图/说明 |  | ☐ |
| 25 | 发布准备 | 回滚预案 | P0 | 可恢复到上版本 | 记录流程 | 文档 |  | ☐ |

---

## 附录：自动化测试命令

```bash
# 单元测试
npm run test:run

# 覆盖率测试
npm run test:coverage

# E2E 测试
npm run test:e2e

# 全部测试
npm run test:all
```
