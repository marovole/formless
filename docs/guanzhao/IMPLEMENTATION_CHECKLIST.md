# è§‚ç…§ç³»ç»Ÿå®æ–½æ£€æŸ¥åˆ—è¡¨

æœ¬æ–‡æ¡£åˆ—å‡ºäº†è§‚ç…§ç³»ç»Ÿå·²å®ç°çš„ç»„ä»¶å’Œå¾…å®Œæˆçš„éƒ¨ç½²ä»»åŠ¡ã€‚

## âœ… å·²å®Œæˆçš„å®ç°

### 1. æ•°æ®åº“å±‚ï¼ˆ100% å®Œæˆï¼‰

- [x] **åŸºç¡€æ¶æ„è¿ç§»** (`20250102000000_base_schema.sql`)
  - users è¡¨åŸºç¡€ç»“æ„
  - è®¤è¯å’Œæƒé™é…ç½®

- [x] **è§‚ç…§ç³»ç»Ÿè¿ç§»** (`20250102000001_guanzhao_system.sql`)
  - `guanzhao_settings`: ç”¨æˆ·è§‚ç…§é…ç½®
  - `user_sessions`: ä¼šè¯è¿½è¸ª
  - `user_session_events`: ä¼šè¯äº‹ä»¶
  - `guanzhao_trigger_history`: è§¦å‘å†å²
  - `guanzhao_user_actions`: ç”¨æˆ·åŠ¨ä½œ
  - `guanzhao_cooldowns`: å†·å´ç®¡ç†
  - `guanzhao_budget_tracking`: é¢„ç®—è¿½è¸ª
  - `guanzhao_user_feedback`: ç”¨æˆ·åé¦ˆ
  - RLS ç­–ç•¥å’Œå®‰å…¨å‡½æ•°
  - åˆå§‹æ•°æ®å’Œé»˜è®¤é…ç½®

- [x] **å®šæ—¶ä»»åŠ¡é…ç½®** (`20250102000002_setup_cron_jobs.sql`)
  - èŠ‚å¾‹å‹è§¦å‘å™¨æ£€æŸ¥ï¼ˆæ¯ 5 åˆ†é’Ÿï¼‰
  - æ¯æ—¥é¢„ç®—é‡ç½®
  - æ¯å‘¨é¢„ç®—é‡ç½®
  - å†·å´è®°å½•æ¸…ç†
  - ä¼šè¯è®°å½•æ¸…ç†

### 2. æ ¸å¿ƒåº“ï¼ˆ100% å®Œæˆï¼‰

- [x] **é…ç½®ç®¡ç†** (`lib/guanzhao/config.ts`)
  - é…ç½®æ–‡ä»¶åŠ è½½å’Œè§£æ
  - æ¨¡æ¿é€‰æ‹©å’Œç®¡ç†
  - åŠ¨ä½œæ˜ å°„

- [x] **é¢„ç®—ç³»ç»Ÿ** (`lib/guanzhao/budget.ts`)
  - é¢„ç®—åˆ†é…å’Œç®¡ç†
  - é¢‘ç‡çº§åˆ«å®šä¹‰
  - é¢„ç®—æ¶ˆè€—è¿½è¸ª

- [x] **å®‰å…¨æ£€æµ‹** (`lib/guanzhao/safetyKeywords.ts`)
  - é£é™©å…³é”®è¯åº“
  - å†…å®¹æ£€æµ‹é€»è¾‘
  - å®‰å…¨æµè§¦å‘

- [x] **ç±»å‹å®šä¹‰** (`lib/guanzhao/types.ts`)
  - TypeScript æ¥å£å®šä¹‰
  - å®Œæ•´çš„ç±»å‹ç³»ç»Ÿ

### 3. Edge Functionsï¼ˆ100% å®Œæˆï¼‰

- [x] **ä¼šè¯è¿½è¸ªå™¨** (`supabase/functions/guanzhao/session-tracker/index.ts`)
  - ä¼šè¯å¼€å§‹/ç»“æŸ/æ´»åŠ¨äº‹ä»¶å¤„ç†
  - è§¦å‘å™¨æ¡ä»¶è¯„ä¼°
  - ä¸æ•°æ®åº“é›†æˆ

- [x] **è§¦å‘å¼•æ“** (`supabase/functions/guanzhao/trigger-engine/index.ts`)
  - è§¦å‘æ¡ä»¶æ£€æŸ¥
  - é¢„ç®—å’Œå†·å´ç®¡ç†
  - æ¨¡æ¿é€‰æ‹©å’Œæ¸²æŸ“
  - è§¦å‘è®°å½•

- [x] **é…ç½®æ–‡ä»¶** (`supabase/functions/import_map.json`)
  - Deno ä¾èµ–ç®¡ç†
  - å¯¼å…¥æ˜ å°„

### 4. API Routesï¼ˆ100% å®Œæˆï¼‰

- [x] **ä¼šè¯ç®¡ç†** (`app/api/guanzhao/session/route.ts`)
  - ä¼šè¯äº‹ä»¶è½¬å‘
  - ä¸ Edge Functions é›†æˆ

- [x] **è®¾ç½®ç®¡ç†** (`app/api/guanzhao/settings/route.ts`)
  - è¯»å–/æ›´æ–°ç”¨æˆ·è®¾ç½®
  - é»˜è®¤é…ç½®å¤„ç†

- [x] **åŠ¨ä½œå¤„ç†** (`app/api/guanzhao/actions/route.ts`)
  - ç”¨æˆ·åŠ¨ä½œå“åº”
  - é™é»˜/åé¦ˆå¤„ç†

- [x] **è§¦å‘è¯„ä¼°** (`app/api/guanzhao/trigger/route.ts`)
  - è§¦å‘å™¨è¯„ä¼°è¯·æ±‚
  - æ¨¡æ¿è·å–

- [x] **æ¨é€ä»¤ç‰Œ** (`app/api/guanzhao/push-token/route.ts`)
  - æ¨é€ä»¤ç‰Œæ³¨å†Œ
  - ä»¤ç‰Œç®¡ç†

### 5. å‰ç«¯ç»„ä»¶ï¼ˆ100% å®Œæˆï¼‰

- [x] **ä¼šè¯è¿½è¸ª Hook** (`lib/hooks/useSessionTracking.ts`)
  - `useSessionTracking`: ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - `useGuanzhaoTriggers`: è§¦å‘å™¨çŠ¶æ€ç®¡ç†
  - `usePushNotifications`: æ¨é€é€šçŸ¥ç®¡ç†
  - å¿ƒè·³å’Œå¯è§æ€§è¿½è¸ª

- [x] **è§¦å‘å™¨å¡ç‰‡** (`components/guanzhao/GuanzhaoTriggerCard.tsx`)
  - `GuanzhaoTriggerCard`: å•ä¸ªè§¦å‘å™¨å±•ç¤º
  - `GuanzhaoTriggerContainer`: è§¦å‘å™¨å®¹å™¨
  - é£æ ¼åŒ–æ¸²æŸ“ï¼ˆæ…ˆæ‚²/æ¸…æ˜/ç›´æŒ‡ï¼‰
  - åŠ¨ä½œæŒ‰é’®å¤„ç†

- [x] **è®¾ç½®é¡µé¢** (`app/[locale]/settings/guanzhao/page.tsx`)
  - è§‚ç…§å¼€å…³
  - é¢‘ç‡çº§åˆ«é€‰æ‹©
  - é£æ ¼é€‰æ‹©
  - æ¨é€é€šçŸ¥é…ç½®
  - DND æ—¶æ®µè®¾ç½®

- [x] **èŠå¤©é¡µé¢é›†æˆ** (`app/[locale]/chat/page.tsx`)
  - ä¼šè¯è¿½è¸ªé›†æˆ
  - è§¦å‘å™¨å±•ç¤º
  - äº‹ä»¶ç›‘å¬å’Œå¤„ç†

- [x] **UI ç»„ä»¶**
  - `components/ui/switch.tsx`: Switch ç»„ä»¶
  - `components/ui/radio-group.tsx`: RadioGroup ç»„ä»¶

### 6. é…ç½®ä¸æ–‡æ¡£ï¼ˆ100% å®Œæˆï¼‰

- [x] **Supabase é…ç½®** (`supabase/config.toml`)
  - é¡¹ç›®é…ç½®
  - Edge Functions è®¾ç½®
  - æ•°æ®åº“é…ç½®

- [x] **éƒ¨ç½²æ–‡æ¡£** (`docs/guanzhao/DEPLOYMENT.md`)
  - å®Œæ•´éƒ¨ç½²æ­¥éª¤
  - ç¯å¢ƒé…ç½®è¯´æ˜

- [x] **README** (`docs/guanzhao/README.md`)
  - ç³»ç»Ÿæ¦‚è§ˆ
  - å·²å®ç°ç»„ä»¶åˆ—è¡¨

---

## âš ï¸ å¾…å®Œæˆçš„éƒ¨ç½²ä»»åŠ¡

### é˜¶æ®µ 1: ç¯å¢ƒå‡†å¤‡

- [ ] **1.1 Supabase é¡¹ç›®é…ç½®**
  - [ ] è·å– Supabase é¡¹ç›®å¼•ç”¨ ID
  - [ ] æ›´æ–° `supabase/config.toml` ä¸­çš„ `project_id`
  - [ ] æ‰§è¡Œ `supabase link --project-ref YOUR_PROJECT_REF`

- [ ] **1.2 ç¯å¢ƒå˜é‡é…ç½®**
  - [ ] é…ç½® `NEXT_PUBLIC_SUPABASE_URL`
  - [ ] é…ç½® `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - [ ] é…ç½® `SUPABASE_SERVICE_ROLE_KEY`ï¼ˆEdge Functions ä½¿ç”¨ï¼‰

### é˜¶æ®µ 2: æ•°æ®åº“éƒ¨ç½²

- [ ] **2.1 æ‰§è¡Œè¿ç§»**
  ```bash
  # æœ¬åœ°æµ‹è¯•
  supabase db reset

  # ç”Ÿäº§ç¯å¢ƒ
  supabase db push
  ```

- [ ] **2.2 éªŒè¯è¡¨ç»“æ„**
  - [ ] æ£€æŸ¥æ‰€æœ‰è¡¨å·²åˆ›å»º
  - [ ] éªŒè¯ RLS ç­–ç•¥
  - [ ] æµ‹è¯•æ•°æ®åº“å‡½æ•°

- [ ] **2.3 å¯ç”¨ pg_cron æ‰©å±•**
  - [ ] åœ¨ Supabase Dashboard â†’ Database â†’ Extensions å¯ç”¨ `pg_cron`
  - [ ] æ‰§è¡Œ `20250102000002_setup_cron_jobs.sql`
  - [ ] é…ç½®ç¯å¢ƒå˜é‡ï¼ˆ`app.settings.supabase_url` ç­‰ï¼‰

### é˜¶æ®µ 3: Edge Functions éƒ¨ç½²

- [ ] **3.1 éƒ¨ç½² Functions**
  ```bash
  # éƒ¨ç½²ä¼šè¯è¿½è¸ªå™¨
  supabase functions deploy guanzhao/session-tracker

  # éƒ¨ç½²è§¦å‘å¼•æ“
  supabase functions deploy guanzhao/trigger-engine
  ```

- [ ] **3.2 é…ç½® Secrets**
  ```bash
  supabase secrets set SUPABASE_URL=your_url
  supabase secrets set SUPABASE_SERVICE_ROLE_KEY=your_key
  ```

- [ ] **3.3 æµ‹è¯• Functions**
  - [ ] æµ‹è¯•ä¼šè¯è¿½è¸ª API
  - [ ] æµ‹è¯•è§¦å‘å¼•æ“ API
  - [ ] æ£€æŸ¥å‡½æ•°æ—¥å¿—

### é˜¶æ®µ 4: å‰ç«¯éƒ¨ç½²

- [ ] **4.1 æœ¬åœ°æµ‹è¯•**
  ```bash
  npm install
  npm run dev
  ```
  - [ ] è®¿é—® `/settings/guanzhao` æµ‹è¯•è®¾ç½®é¡µé¢
  - [ ] è®¿é—® `/chat` æµ‹è¯•ä¼šè¯è¿½è¸ª
  - [ ] è§¦å‘æµ‹è¯•æ¶ˆæ¯

- [ ] **4.2 ç”Ÿäº§æ„å»º**
  ```bash
  npm run build
  npm run start
  ```

### é˜¶æ®µ 5: åŠŸèƒ½æµ‹è¯•

- [ ] **5.1 åŸºç¡€æµç¨‹æµ‹è¯•**
  - [ ] ç”¨æˆ·æ³¨å†Œå¹¶å¯ç”¨è§‚ç…§
  - [ ] è®¾ç½®é¢‘ç‡çº§åˆ«å’Œé£æ ¼
  - [ ] å¼€å§‹èŠå¤©ä¼šè¯
  - [ ] éªŒè¯ä¼šè¯è¿½è¸ª

- [ ] **5.2 è§¦å‘å™¨æµ‹è¯•**
  - [ ] æµ‹è¯• `daily_checkin`ï¼ˆé¦–æ¬¡ä¼šè¯ï¼‰
  - [ ] æµ‹è¯• `nightly_wrapup`ï¼ˆæ™šä¸Šç»“æŸä¼šè¯ï¼‰
  - [ ] æµ‹è¯• `overload_protection`ï¼ˆé•¿æ—¶é—´ä¼šè¯ï¼‰
  - [ ] éªŒè¯é¢„ç®—æ¶ˆè€—
  - [ ] éªŒè¯å†·å´æœºåˆ¶

- [ ] **5.3 ç”¨æˆ·äº¤äº’æµ‹è¯•**
  - [ ] ç‚¹å‡»è§¦å‘å™¨æŒ‰é’®
  - [ ] æµ‹è¯•é™é»˜åŠŸèƒ½
  - [ ] æµ‹è¯•åé¦ˆæäº¤
  - [ ] éªŒè¯ DND æ—¶æ®µ

- [ ] **5.4 æ¨é€é€šçŸ¥æµ‹è¯•**ï¼ˆå¯é€‰ï¼‰
  - [ ] é…ç½®æ¨é€ä»¤ç‰Œ
  - [ ] æµ‹è¯•æ¨é€è§¦å‘
  - [ ] éªŒè¯ DND æ—¶æ®µå¯¹æ¨é€çš„å½±å“

### é˜¶æ®µ 6: ç›‘æ§ä¸ä¼˜åŒ–

- [ ] **6.1 æ•°æ®åº“ç›‘æ§**
  - [ ] ç›‘æ§ pg_cron ä»»åŠ¡æ‰§è¡Œ
  - [ ] æ£€æŸ¥è§¦å‘å†å²æ•°æ®
  - [ ] éªŒè¯é¢„ç®—é‡ç½®

- [ ] **6.2 Edge Functions ç›‘æ§**
  - [ ] æŸ¥çœ‹å‡½æ•°æ‰§è¡Œæ—¥å¿—
  - [ ] ç›‘æ§é”™è¯¯ç‡
  - [ ] ä¼˜åŒ–æ€§èƒ½

- [ ] **6.3 ç”¨æˆ·åé¦ˆæ”¶é›†**
  - [ ] åˆ†æè§¦å‘é¢‘ç‡
  - [ ] æ”¶é›†ç”¨æˆ·åé¦ˆ
  - [ ] è°ƒæ•´è§¦å‘ç­–ç•¥

---

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: æ•°æ®åº“è¿ç§»å¤±è´¥

**ç—‡çŠ¶**: `relation "users" does not exist`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç¡®ä¿æŒ‰é¡ºåºæ‰§è¡Œè¿ç§»
supabase db reset
```

### é—®é¢˜ 2: Edge Functions æ— æ³•è®¿é—®

**ç—‡çŠ¶**: 401 Unauthorized

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ `Authorization` header
- éªŒè¯ service role key
- æ£€æŸ¥ CORS é…ç½®

### é—®é¢˜ 3: è§¦å‘å™¨ä¸å·¥ä½œ

**ç—‡çŠ¶**: è§¦å‘å™¨æ²¡æœ‰æ˜¾ç¤º

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ç”¨è§‚ç…§ï¼ˆ`guanzhao_budget_tracking.enabled = true`ï¼‰
2. æ£€æŸ¥é¢„ç®—æ˜¯å¦å……è¶³
3. æ£€æŸ¥å†·å´æ—¶é—´
4. æŸ¥çœ‹ `guanzhao_trigger_history` è¡¨

### é—®é¢˜ 4: å®šæ—¶ä»»åŠ¡ä¸æ‰§è¡Œ

**ç—‡çŠ¶**: pg_cron ä»»åŠ¡æ²¡æœ‰è¿è¡Œ

**æ’æŸ¥æ­¥éª¤**:
1. éªŒè¯ `pg_cron` æ‰©å±•å·²å¯ç”¨
2. æ£€æŸ¥ `cron.job` è¡¨
3. æŸ¥çœ‹ `cron.job_run_details` æ‰§è¡Œå†å²
4. éªŒè¯ç¯å¢ƒå˜é‡é…ç½®

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
- [ ] å®Œæˆéƒ¨ç½²å’ŒåŸºç¡€æµ‹è¯•
- [ ] æ”¶é›†åˆæ­¥ç”¨æˆ·åé¦ˆ
- [ ] ä¿®å¤å‘ç°çš„ bug

### ä¸­æœŸï¼ˆ2-4 å‘¨ï¼‰
- [ ] å®ç°è¡Œä¸ºå‹è§¦å‘å™¨ï¼ˆå¦‚ `stagnant_pattern`ï¼‰
- [ ] å®Œå–„é£é™©æ£€æµ‹å’Œå®‰å…¨æµ
- [ ] æ·»åŠ æ•°æ®åˆ†æä»ªè¡¨æ¿

### é•¿æœŸï¼ˆ1-3 ä¸ªæœˆï¼‰
- [ ] A/B æµ‹è¯•ä¸åŒè§¦å‘ç­–ç•¥
- [ ] æœºå™¨å­¦ä¹ æ¨¡å‹ä¼˜åŒ–
- [ ] å¤šè¯­è¨€æ”¯æŒ
- [ ] é«˜çº§ä¸ªæ€§åŒ–åŠŸèƒ½

---

## ğŸ“ æ”¯æŒä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼Œè¯·ï¼š
1. æŸ¥çœ‹ `docs/guanzhao/DEPLOYMENT.md` è¯¦ç»†æ–‡æ¡£
2. æ£€æŸ¥æœ¬æ¸…å•çš„å¸¸è§é—®é¢˜éƒ¨åˆ†
3. æŸ¥çœ‹ Supabase Dashboard çš„æ—¥å¿—å’Œç›‘æ§

---

**æœ€åæ›´æ–°**: 2026-01-02
**ç‰ˆæœ¬**: v1.0.0 (Phase 1 Complete)
